<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.UserDAO">

  <select id="findNicknameByUserId" resultType="String" parameterType="String"> SELECT user_nickname FROM users WHERE user_id = #{userId} </select>
  <select id="loginYn" parameterType="hashmap" resultType="string">
        select user_pw from users where user_id=#{user_id}
  </select>
    
  <insert id="register" parameterType="hashmap">
        insert into users(user_id, user_pw, user_email, user_phone_num, user_post_num, user_address, user_detail_address, user_name, user_nickname) 
        values(#{user_id},#{user_pw},#{user_email},#{user_phone_num},#{user_post_num},#{user_address},#{user_detail_address},#{user_name},#{user_nickname})
  </insert>
	
  <!-- 	ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ -->
  <select id="checkId" parameterType="string" resultType="int">
        select count(*) from users where user_id = #{user_id}
  </select>
    
  <!--     ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ -->
  <select id="checkEmail" parameterType="String" resultType="int">
    	select count(*) from users where user_email = #{user_email}
  </select>
    
  <select id="findIdByEmail" parameterType="String" resultType="String">
        select user_id from users where user_email = #{user_email}
  </select>
    
  <!--     ì•„ì´ë””, ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ìŒ -->
  <select id="findPwByIdEmail" parameterType="map" resultType="string">
        select user_id from users where user_id = #{user_id} and user_email = #{user_email}
  </select>
    
  <!--     ì‚¬ìš©ìžì˜ ì•„ì´ë””ì™€ ìƒì„±ëœ í† í°ì„ ë°›ì•„, ë°ì´í„°ë² ì´ìŠ¤ í† í°ì„ ì €ìž¥(ì‚¬ìš©ìžê°€ ìž¬ì„¤ì •í•  ê¶Œí•œì´ ìžˆìŒì„ ì¦ëª…) -->
  <update id="saveResetToken" parameterType="map">
 		update users set user_pwd_reset= #{user_pwd_reset} where user_id= #{user_id}
  </update>
 	
  <!-- 	 í† í°ìœ¼ë¡œ ì‚¬ìš©ìž ì¡°íšŒ -->
  <select id="findUserByResetToken" parameterType="string" resultType="com.boot.dto.UserDTO">
        select * from users where user_pwd_reset = #{user_pwd_reset}
  </select>
 	
  <!--  	í† í°ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ -->
  <update id="updatePasswordByToken" parameterType="hashmap">
 		update users set user_pw= #{user_pw},user_pwd_reset = NULL where user_pwd_reset= #{user_pwd_reset}
  </update>
 
  <!-- ì•„ì´ë””ë¡œ íšŒì› ì •ë³´ ì¡°íšŒ (ìž ê¸ˆìƒíƒœ, ì„¸ì…˜ìš©) -->
  <select id="getUserById" parameterType="string" resultType="com.boot.dto.UserDTO">
        SELECT *
        FROM users
        WHERE user_id = #{user_id}
  </select>
 	
  <!-- ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì‹œë„ íšŸìˆ˜ +1, ì‹œê°„ ê°±ì‹  -->
  <update id="updateLoginFail">
        UPDATE users
        SET login_fail_count = login_fail_count + 1,
            last_fail_time = SYSDATE
        WHERE user_id = #{user_id}
  </update>

  <!-- ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì´ˆê¸°í™” -->
  <update id="resetLoginFail">
        UPDATE users
        SET login_fail_count = 0,
            last_fail_time = NULL
        WHERE user_id = #{user_id}
  </update>
    
  <!-- ì´ë©”ì¼ë¡œ ê¸°ì¡´ íšŒì› ì¡°íšŒ -->
  <select id="getUserByEmail" parameterType="string" resultType="com.boot.dto.UserDTO">
	    SELECT * FROM users WHERE user_email = #{user_email}
  </select>
	
  <!-- ì†Œì…œ ì‹ ê·œ íšŒì› ë“±ë¡ -->
  <insert id="insertSocialUser" parameterType="map">
        INSERT INTO users (
            user_id,
            user_pw,
            user_email,
            user_name,
            user_nickname,
            login_type,
            social_id,
            user_email_chk,
            user_phone_num,
            user_post_num, 
            user_address, 
            user_detail_address,
            reg_date
        ) VALUES (
            #{user_id},
            'SOCIAL_LOGIN',
            #{user_email},
            #{user_name},
            #{user_nickname},
            #{login_type},
            #{social_id},
            'Y',
            '000-0000-0000',
            '47354',
            'ë¶€ì‚°ì‹œ',
            'ë²”ë‚´ê³¨',
            SYSDATE
        )
  </insert>

  <!-- ðŸ”¥ ë§ˆì´íŽ˜ì´ì§€: ë‹¨ê±´ ì¡°íšŒ (ì—¬ê¸°ì— user_role ì¶”ê°€ë¨) -->
  <select id="selectUser" parameterType="hashmap" resultType="hashmap">
    SELECT
        user_id             AS "user_id",
        user_name           AS "user_name",
        user_nickname       AS "user_nickname",
        user_email          AS "user_email",
        user_phone_num      AS "user_phone_num",
        user_post_num       AS "user_post_num",
        user_address        AS "user_address",
        user_detail_address AS "user_detail_address",
        user_role           AS "user_role",          <!-- â­ ì´ ì¤„ ì¶”ê°€ í•µì‹¬ -->
        TO_CHAR(reg_date, 'YYYY-MM-DD')        AS "reg_date",
        TO_CHAR(last_login_date, 'YYYY-MM-DD') AS "last_login_date"
    FROM users
    WHERE user_id = #{user_id, jdbcType=VARCHAR}
  </select>

  <!-- ë§ˆì´íŽ˜ì´ì§€: ì •ë³´ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì œì™¸) -->
  <update id="updateUser" parameterType="hashmap">
    UPDATE users
       SET user_name            = #{user_name, jdbcType=VARCHAR},
           user_nickname        = #{user_nickname, jdbcType=VARCHAR},
           user_email           = #{user_email, jdbcType=VARCHAR},
           user_phone_num       = #{user_phone_num, jdbcType=VARCHAR},
           user_post_num        = #{user_post_num, jdbcType=VARCHAR},
           user_address         = #{user_address, jdbcType=VARCHAR},
           user_detail_address  = #{user_detail_address, jdbcType=VARCHAR}
     WHERE user_id = #{user_id, jdbcType=VARCHAR}
  </update>

  <delete id="withdraw" parameterType="hashmap">
	  DELETE FROM users
	  WHERE user_id = #{user_id, jdbcType=VARCHAR}
	    AND user_pw = #{user_pw, jdbcType=VARCHAR}
  </delete>
	
  <!-- ì†Œì…œ ë¡œê·¸ì¸ íšŒì› íƒˆí‡´ -->
  <delete id="withdrawSocial" parameterType="map">
	  DELETE FROM users
	  WHERE user_id = #{user_id, jdbcType=VARCHAR}
	    AND login_type = #{login_type, jdbcType=VARCHAR}
  </delete>

</mapper>
